{% extends 'ph/base.html' %}
{% load static %}

{% block content %}

<h1 class="h1-fixed">Edição de Hosts</h1>
<div class="form-wrapper">
  
  <form class="form-wrapper" method="POST" action="{% url 'retorna_host' %}">
    {% csrf_token %}
    <div class="form-row">
      <div class="input-container">
        <div class="subinput-container">
          <div class="input-column">
            <input type="hidden" id="host-id" name="host_id" value="{{host.id}}">
            <label for="ip_host">IP do Host:</label>
            <input type="text" id="ip_host" name="ip_host" value="{{host.ip_host}}" class="medium-input" required>
            <label for="dns_host">DNS do Host:</label>
            <input type="text" id="dns_host" name="dns_host" value="{{host.dns_host}}" class="medium-input" required>
            <label for="nome_host">Nome do Host:</label>
            <input type="text" id="nome_host" name="nome_host" value="{{host.nome_host}}" class="medium-input" required>
            <label for="categoria_host">Categoria do Host:</label>
            <input type="text" id="categoria_host" name="categoria_host" value="{{host.categoria_host}}" class="medium-input" required>
          </div>
          <div class="input-column">
            <label for="cep">CEP:</label>
            <input type="text" id="cep" name="cep" value="{{endereco.cep}}" class="short-input" required>
            <label for="logradouro">Logradouro:</label>
            <input type="text" id="logradouro" name="logradouro" value="{{endereco.logradouro}}" class="medium-input" required>
            <label for="numero">Número:</label>
            <input type="text" id="numero" name="numero" value="{{endereco.numero}}" class="short-input" required>
            <label for="complemento">Complemento:</label>
            <input type="text" id="complemento" name="complemento" value="{{endereco.complemento}}" class="medium-input">
            <label for="bairro">Bairro:</label>
            <input type="text" id="bairro" name="bairro" value="{{endereco.bairro}}" class="medium-input" required>
            <label for="cidade">Cidade:</label>
            <input type="text" id="cidade" name="cidade" value="{{endereco.cidade}}" class="medium-input" required>
            <label for="estado">Estado:</label>
            <input type="text" id="estado" name="estado" value="{{endereco.estado}}" class="short-input" required>
            <label for="latitude">Latitude:</label>
            <input type="text" id="latitude" name="latitude" value="{{endereco.latitude}}" class="short-input">
            <label for="longitude">Longitude:</label>
            <input type="text" id="longitude" name="longitude" value="{{endereco.longitude}}" class="short-input">
          </div>
        </div>
        <div class="input-map-container">
          <h3 for="map-cadastro" class="localizacao">Localização:</h3>
            <div class="map-cadastro" id="map-cadastro">
             </div>
        </div>
      </div>
    </div>

  </form>

</div>
<div class="buttons">
    {% csrf_token %}
    <button id="btn-atualizar">Salvar</button>
    <button id="btn-carregar-cord">Carregar Coordenada</button>  
</div>


  <!-- Seção de mensagens de sucesso -->
  {% if messages %}
    <div class="popup">
      <ul class="success-messages">
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
    <!-- Mensagem de sucesso -->
    <div id="success-message" class="message success-message" style="display: none;"></div>

    <!-- Mensagem de erro -->
    <div id="error-message" class="message error-message" style="display: none;"></div>
  



<script>
  // Faça uma solicitação AJAX para obter a chave da API do servidor
  fetch("{% url 'api_key' %}")
    .then(response => response.json())
    .then(data => {
      const api_key = data.api_key;
      // Seu código JavaScript que usa a chave da API aqui
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${api_key}&callback=initMap`;
      script.async = true;
      script.defer = true;
      document.head.appendChild(script);
    })
    .catch(error => {
      console.error("Erro ao obter a chave da API:", error);
    });
</script>
    
<script>
  function initMap() {
    // Define as coordenadas iniciais do mapa
    const initialCoords = { lat: -23.5505, lng: -46.6333 };

    // Crie um novo mapa e vincule-o à div com o ID "map-cadastro"
    const map = new google.maps.Map(document.getElementById("map-cadastro"), {
      center: initialCoords,
      zoom: 20,
      mapTypeId: 'hybrid'
    });
 
    // Adicione um marcador no mapa
    const marker = new google.maps.Marker({
      position: initialCoords,
      map: map,
      draggable: true, // Permita que o marcador seja arrastado pelo usuário
      
    });

    // Evento de arrastar do marcador
    marker.addListener("dragend", () => {
      // Obtenha as novas coordenadas do marcador
      const newCoords = marker.getPosition();
      const latitude = parseFloat(newCoords.lat().toFixed(7));
      const longitude = parseFloat(newCoords.lng().toFixed(7));

      // Preencha os campos de latitude e longitude com as novas coordenadas
      document.getElementById("latitude").value = latitude;
      document.getElementById("longitude").value = longitude;
    });
    // Armazene a referência ao objeto 'map' em 'window.map'
    window.map = {
    map: map,
    marker: marker
    };
  }

   
  // Função para carregar coordenadas
function carregarCoordenadas() {
  console.log('Carregando coordenadas...');
  // Obter os valores dos campos de endereço
  const cep = document.getElementById('cep').value;
  const logradouro = document.getElementById('logradouro').value;
  const numero = document.getElementById('numero').value;
  const complemento = document.getElementById('complemento').value;
  const bairro = document.getElementById('bairro').value;
  const cidade = document.getElementById('cidade').value;
  const estado = document.getElementById('estado').value;

  // Logar os valores dos campos
  console.log('cep:', cep);
  console.log('logradouro:', logradouro);
  console.log('numero:', numero);
  console.log('complemento:', complemento);
  console.log('bairro:', bairro);
  console.log('cidade:', cidade);
  console.log('estado:', estado);

  // Criar um objeto com os dados do formulário
  const formData = {
    cep: cep,
    logradouro: logradouro,
    numero: numero,
    complemento: complemento,
    bairro: bairro,
    cidade: cidade,
    estado: estado
  };
  
  // Enviar uma requisição POST para a URL de cadastro
  console.log('Enviando requisição POST para /carregar_coordenadas/');
  fetch('/carregar_coordenadas/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: new URLSearchParams(formData).toString()
  })
  .then(response => {
    console.log('Resposta recebida', response);
    return response.json();
  })
  .then(data => {
    console.log('Dados recebidos:', data);
    if (data.latitude && data.longitude) {
      console.log('Preenchendo coordenadas com latitude:', data.latitude, 'e longitude:', data.longitude);
      // Preencher os campos de latitude e longitude com os valores recebidos
      preencherCoordenadas(data.latitude, data.longitude);
    } else {
      console.error('Erro ao obter as coordenadas do endereço.');
    }
  })
  .catch(error => {
    console.error('Erro na requisição:', error);
  });
}

// Carregar coordenadas ao carregar a página
document.addEventListener('DOMContentLoaded', carregarCoordenadas);

// Carregar coordenadas ao clicar no botão
const btnLoc = document.querySelector('#btn-carregar-cord');
btnLoc.addEventListener('click', carregarCoordenadas);

</script>

<script>
      
  const btnAtualizar = document.querySelector('#btn-atualizar');
  btnAtualizar.addEventListener('click', () => {
  const ipHost = document.getElementById('ip_host').value;
  const dnsHost = document.getElementById('dns_host').value;
  const nomeHost = document.getElementById('nome_host').value;
  const categoriaHost = document.getElementById('categoria_host').value;
  const cep = document.getElementById('cep').value;
  const logradouro = document.getElementById('logradouro').value;
  const numero = document.getElementById('numero').value;
  const complemento = document.getElementById('complemento').value;
  const bairro = document.getElementById('bairro').value;
  const cidade = document.getElementById('cidade').value;
  const estado = document.getElementById('estado').value;
  const latitude = document.getElementById('latitude').value;
  const longitude = document.getElementById('longitude').value;
  const hostId = document.getElementById('host-id').value;  
  const formData = {
    host_id: hostId,
    ip_host: ipHost,
    dns_host: dnsHost,
    nome_host: nomeHost,
    categoria_host: categoriaHost,
    cep: cep,
    logradouro: logradouro,
    numero: numero,
    complemento: complemento,
    bairro: bairro,
    cidade: cidade,
    estado: estado,
    latitude: latitude,
    longitude: longitude,
  };
  fetch('/atualizar_host/', { 
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: new URLSearchParams(formData).toString()
  })
    .then(response => {
      if (response.ok) {
        alert('Host atualizado com sucesso!');
      } else {
        throw new Error('Erro ao atualizar o host.');
      }
  })
  .catch(error => {
      console.error(error);
    });
  });
</script>

<script src="{% static 'js/script.js' %}"></script>

{% endblock %}
